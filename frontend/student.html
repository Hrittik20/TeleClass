<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: #4CAF50; color: white; }
        .badge-warning { background: #FF9800; color: white; }
        .badge-danger { background: #F44336; color: white; }
    </style>
</head>
<body>
    <div id="app" class="max-w-4xl mx-auto p-4">
        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading...</p>
        </div>

        <!-- Main Content -->
        <div id="content" style="display: none;">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold">üìö Student Dashboard</h1>
                    <p id="studentName" class="text-sm text-gray-600"></p>
                </div>
                <button id="btnEnrollCourse" class="btn-primary">
                    ‚ûï Enroll in Course
                </button>
            </div>

            <!-- Tabs -->
            <div class="mb-6">
                <div class="flex border-b">
                    <button id="tabAssignments" class="py-2 px-4 font-medium border-b-2 border-blue-500">
                        Assignments
                    </button>
                    <button id="tabCourses" class="py-2 px-4 font-medium text-gray-500">
                        My Courses
                    </button>
                    <button id="tabProgress" class="py-2 px-4 font-medium text-gray-500">
                        Progress
                    </button>
                </div>
            </div>

            <!-- Assignments Tab Content -->
            <div id="assignmentsContent">
                <div class="mb-4">
                    <input type="text" id="searchAssignments" placeholder="Search assignments..." 
                           class="w-full p-3 rounded-lg border">
                </div>
                
                <div id="assignmentsList"></div>
                
                <!-- Empty State -->
                <div id="emptyAssignments" style="display: none;" class="text-center py-12">
                    <div class="text-6xl mb-4">üìù</div>
                    <h3 class="text-xl font-bold mb-2">No Assignments Yet</h3>
                    <p class="text-gray-600">Assignments from your courses will appear here.</p>
                </div>
            </div>

            <!-- Courses Tab Content -->
            <div id="coursesContent" style="display: none;">
                <div id="coursesList"></div>
                
                <!-- Empty State -->
                <div id="emptyCourses" style="display: none;" class="text-center py-12">
                    <div class="text-6xl mb-4">üéì</div>
                    <h3 class="text-xl font-bold mb-2">No Courses Yet</h3>
                    <p class="text-gray-600 mb-6">Enroll in a course to get started!</p>
                    <button id="btnEmptyEnroll" class="btn-primary">
                        Enroll Now
                    </button>
                </div>
            </div>

            <!-- Progress Tab Content -->
            <div id="progressContent" style="display: none;">
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">Your Progress</h3>
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span>Assignments Completed</span>
                            <span id="completionRate">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="completionBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="progressStats" class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="totalAssignments">0</div>
                            <div class="text-sm text-gray-600">Total Assignments</div>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="completedAssignments">0</div>
                            <div class="text-sm text-gray-600">Completed</div>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" id="pendingAssignments">0</div>
                            <div class="text-sm text-gray-600">Pending</div>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" id="lateAssignments">0</div>
                            <div class="text-sm text-gray-600">Late</div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <h3 class="font-bold text-lg mb-4">Course Progress</h3>
                    <div id="courseProgressList"></div>
                </div>
            </div>
        </div>

        <!-- Enroll Modal -->
        <div id="enrollModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-lg w-full">
                <h2 class="text-xl font-bold mb-4">üéì Enroll in a Course</h2>
                
                <form id="enrollForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Course Code *</label>
                        <input type="text" id="enrollCode" required 
                               placeholder="Enter course code provided by your teacher"
                               class="w-full p-3 rounded-lg border">
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="hideEnrollForm()" 
                                class="flex-1 p-3 rounded-lg border">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 btn-primary">
                            Enroll
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Assignment Detail Modal -->
        <div id="assignmentDetailModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="assignmentTitle" class="text-xl font-bold"></h2>
                        <p id="assignmentCourse" class="text-sm text-gray-600"></p>
                    </div>
                    <button onclick="hideAssignmentDetail()" class="text-2xl">&times;</button>
                </div>

                <div class="mb-4">
                    <div class="mb-3">
                        <strong>Instructions:</strong>
                        <p id="assignmentInstructions" class="mt-1"></p>
                    </div>
                    <div id="assignmentDue" class="mb-3"></div>
                    <div class="mb-3">
                        <strong>Status:</strong>
                        <span id="assignmentStatus"></span>
                    </div>
                </div>

                <div id="submissionSection" class="border-t pt-4">
                    <h3 class="font-bold mb-3">üì§ Your Submission</h3>
                    
                    <div id="noSubmission">
                        <p class="text-gray-600 mb-4">You haven't submitted anything yet.</p>
                        
                        <form id="submissionForm">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Answer</label>
                                <textarea id="submissionText" rows="4"
                                          placeholder="Type your answer here..."
                                          class="w-full p-3 rounded-lg border"></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Attach Files (Optional)</label>
                                <input type="file" id="submissionFile" class="w-full p-3 rounded-lg border">
                            </div>
                            
                            <button type="submit" class="btn-primary w-full">
                                Submit Assignment
                            </button>
                        </form>
                    </div>
                    
                    <div id="existingSubmission" style="display: none;">
                        <div class="card">
                            <div class="flex justify-between">
                                <div>
                                    <p id="submissionDate" class="text-sm text-gray-600"></p>
                                </div>
                                <span id="submissionStatus" class="badge badge-success">Submitted</span>
                            </div>
                            <p id="submissionTextDisplay" class="mt-3"></p>
                            <div id="submissionFiles" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // State
        let student = null;
        let courses = [];
        let assignments = [];
        let currentAssignment = null;

        // API Helper
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'X-Telegram-Init-Data': tg.initData,
                ...options.headers
            };

            try {
                const response = await fetch(endpoint, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API Error');
                }

                return response.json();
            } catch (error) {
                console.error('API call error:', error);
                tg.showAlert('Error: ' + error.message);
                throw error;
            }
        }

        // Initialize
        async function init() {
            try {
                // Verify auth and get student data
                const authResult = await apiCall('/api/auth/verify', { method: 'POST' });
                student = authResult.student;
                document.getElementById('studentName').textContent = student.name;

                // Load courses
                await loadCourses();
                
                // Load assignments
                await loadAssignments();
                
                // Update progress
                updateProgress();

                // Show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Init error:', error);
                tg.showAlert('Failed to load dashboard: ' + error.message);
            }
        }

        async function loadCourses() {
            try {
                const result = await apiCall('/api/student/courses');
                courses = result.courses;
                renderCourses();
            } catch (error) {
                console.error('Load courses error:', error);
            }
        }

        function renderCourses() {
            const container = document.getElementById('coursesList');
            const emptyState = document.getElementById('emptyCourses');
            
            if (courses.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = courses.map(course => {
                return `
                    <div class="card">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${course.title}</h3>
                                <p class="text-sm text-gray-600">Teacher: ${course.teacher_name}</p>
                            </div>
                            <span class="badge badge-success">Enrolled</span>
                        </div>
                        <div class="mt-3">
                            <p class="text-sm">Assignments: ${course.assignment_count}</p>
                            <p class="text-sm">Completed: ${course.completed_count} / ${course.assignment_count}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadAssignments() {
            try {
                const result = await apiCall('/api/student/assignments');
                assignments = result.assignments;
                renderAssignments();
            } catch (error) {
                console.error('Load assignments error:', error);
            }
        }

        function renderAssignments() {
            const container = document.getElementById('assignmentsList');
            const emptyState = document.getElementById('emptyAssignments');
            
            if (assignments.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = assignments.map(a => {
                const dueDate = a.due_at ? new Date(a.due_at) : null;
                const isOverdue = dueDate && dueDate < new Date();
                
                let statusBadge;
                if (a.submitted) {
                    statusBadge = '<span class="badge badge-success">Submitted</span>';
                } else if (a.closed) {
                    statusBadge = '<span class="badge badge-danger">Closed</span>';
                } else if (isOverdue) {
                    statusBadge = '<span class="badge badge-warning">Overdue</span>';
                } else {
                    statusBadge = '<span class="badge badge-warning">Pending</span>';
                }

                return `
                    <div class="card cursor-pointer hover:opacity-90" onclick="viewAssignment('${a.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${a.title}</h3>
                                <p class="text-sm text-gray-600 mt-1">Course: ${a.course_title}</p>
                                ${dueDate ? `<p class="text-sm text-gray-600">Due: ${dueDate.toLocaleString()}</p>` : ''}
                            </div>
                            <div>
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProgress() {
            if (assignments.length === 0) return;
            
            const total = assignments.length;
            const completed = assignments.filter(a => a.submitted).length;
            const pending = assignments.filter(a => !a.submitted && !a.closed && (!a.due_at || new Date(a.due_at) >= new Date())).length;
            const late = assignments.filter(a => !a.submitted && (a.closed || (a.due_at && new Date(a.due_at) < new Date()))).length;
            
            const completionPercent = Math.round((completed / total) * 100);
            
            document.getElementById('completionRate').textContent = `${completionPercent}%`;
            document.getElementById('completionBar').style.width = `${completionPercent}%`;
            
            document.getElementById('totalAssignments').textContent = total;
            document.getElementById('completedAssignments').textContent = completed;
            document.getElementById('pendingAssignments').textContent = pending;
            document.getElementById('lateAssignments').textContent = late;
            
            // Course progress
            const courseProgressList = document.getElementById('courseProgressList');
            courseProgressList.innerHTML = courses.map(course => {
                const courseCompletionPercent = course.assignment_count > 0 
                    ? Math.round((course.completed_count / course.assignment_count) * 100) 
                    : 0;
                
                return `
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span>${course.title}</span>
                            <span>${courseCompletionPercent}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${courseCompletionPercent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewAssignment(id) {
            try {
                const result = await apiCall(`/api/student/assignments/${id}`);
                currentAssignment = result.assignment;
                
                // Populate modal
                document.getElementById('assignmentTitle').textContent = currentAssignment.title;
                document.getElementById('assignmentCourse').textContent = `Course: ${currentAssignment.course_title}`;
                document.getElementById('assignmentInstructions').textContent = currentAssignment.instructions;
                
                const dueDiv = document.getElementById('assignmentDue');
                if (currentAssignment.due_at) {
                    const dueDate = new Date(currentAssignment.due_at);
                    dueDiv.innerHTML = `<strong>Due:</strong> ${dueDate.toLocaleString()}`;
                } else {
                    dueDiv.innerHTML = '';
                }
                
                const statusSpan = document.getElementById('assignmentStatus');
                if (currentAssignment.closed) {
                    statusSpan.innerHTML = '<span class="badge badge-danger">Closed</span>';
                } else if (currentAssignment.due_at && new Date(currentAssignment.due_at) < new Date()) {
                    statusSpan.innerHTML = '<span class="badge badge-warning">Overdue</span>';
                } else {
                    statusSpan.innerHTML = '<span class="badge badge-success">Open</span>';
                }
                
                // Show submission section based on status
                if (currentAssignment.submission) {
                    document.getElementById('noSubmission').style.display = 'none';
                    document.getElementById('existingSubmission').style.display = 'block';
                    
                    const submissionDate = new Date(currentAssignment.submission.submitted_at);
                    document.getElementById('submissionDate').textContent = `Submitted on ${submissionDate.toLocaleString()}`;
                    document.getElementById('submissionTextDisplay').textContent = currentAssignment.submission.text || 'No text submission';
                    
                    const filesDiv = document.getElementById('submissionFiles');
                    if (currentAssignment.submission.files && currentAssignment.submission.files.length > 0) {
                        filesDiv.innerHTML = currentAssignment.submission.files.map(file => 
                            `<div class="text-sm mt-1">üìé <a href="${file.url}" target="_blank">${file.name}</a></div>`
                        ).join('');
                    } else {
                        filesDiv.innerHTML = '';
                    }
                } else {
                    document.getElementById('noSubmission').style.display = 'block';
                    document.getElementById('existingSubmission').style.display = 'none';
                    
                    // Disable submission if closed
                    const submitButton = document.querySelector('#submissionForm button[type="submit"]');
                    if (currentAssignment.closed) {
                        submitButton.disabled = true;
                        submitButton.classList.add('opacity-50');
                        submitButton.textContent = 'Assignment Closed';
                    } else {
                        submitButton.disabled = false;
                        submitButton.classList.remove('opacity-50');
                        submitButton.textContent = 'Submit Assignment';
                    }
                }
                
                document.getElementById('assignmentDetailModal').style.display = 'flex';
            } catch (error) {
                console.error('View assignment error:', error);
                tg.showAlert('Failed to load assignment: ' + error.message);
            }
        }

        function hideAssignmentDetail() {
            document.getElementById('assignmentDetailModal').style.display = 'none';
            document.getElementById('submissionForm').reset();
        }

        function showEnrollForm() {
            document.getElementById('enrollModal').style.display = 'flex';
        }

        function hideEnrollForm() {
            document.getElementById('enrollModal').style.display = 'none';
            document.getElementById('enrollForm').reset();
        }

        // Tab switching
        document.getElementById('tabAssignments').addEventListener('click', () => {
            document.getElementById('tabAssignments').classList.add('border-blue-500');
            document.getElementById('tabCourses').classList.remove('border-blue-500');
            document.getElementById('tabProgress').classList.remove('border-blue-500');
            
            document.getElementById('tabAssignments').classList.remove('text-gray-500');
            document.getElementById('tabCourses').classList.add('text-gray-500');
            document.getElementById('tabProgress').classList.add('text-gray-500');
            
            document.getElementById('assignmentsContent').style.display = 'block';
            document.getElementById('coursesContent').style.display = 'none';
            document.getElementById('progressContent').style.display = 'none';
        });

        document.getElementById('tabCourses').addEventListener('click', () => {
            document.getElementById('tabAssignments').classList.remove('border-blue-500');
            document.getElementById('tabCourses').classList.add('border-blue-500');
            document.getElementById('tabProgress').classList.remove('border-blue-500');
            
            document.getElementById('tabAssignments').classList.add('text-gray-500');
            document.getElementById('tabCourses').classList.remove('text-gray-500');
            document.getElementById('tabProgress').classList.add('text-gray-500');
            
            document.getElementById('assignmentsContent').style.display = 'none';
            document.getElementById('coursesContent').style.display = 'block';
            document.getElementById('progressContent').style.display = 'none';
        });

        document.getElementById('tabProgress').addEventListener('click', () => {
            document.getElementById('tabAssignments').classList.remove('border-blue-500');
            document.getElementById('tabCourses').classList.remove('border-blue-500');
            document.getElementById('tabProgress').classList.add('border-blue-500');
            
            document.getElementById('tabAssignments').classList.add('text-gray-500');
            document.getElementById('tabCourses').classList.add('text-gray-500');
            document.getElementById('tabProgress').classList.remove('text-gray-500');
            
            document.getElementById('assignmentsContent').style.display = 'none';
            document.getElementById('coursesContent').style.display = 'none';
            document.getElementById('progressContent').style.display = 'block';
        });

        // Event Listeners
        document.getElementById('btnEnrollCourse').addEventListener('click', showEnrollForm);
        document.getElementById('btnEmptyEnroll').addEventListener('click', showEnrollForm);

        document.getElementById('searchAssignments').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredAssignments = assignments.filter(a => 
                a.title.toLowerCase().includes(searchTerm) || 
                a.course_title.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('assignmentsList');
            const emptyState = document.getElementById('emptyAssignments');
            
            if (filteredAssignments.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = filteredAssignments.map(a => {
                const dueDate = a.due_at ? new Date(a.due_at) : null;
                const isOverdue = dueDate && dueDate < new Date();
                
                let statusBadge;
                if (a.submitted) {
                    statusBadge = '<span class="badge badge-success">Submitted</span>';
                } else if (a.closed) {
                    statusBadge = '<span class="badge badge-danger">Closed</span>';
                } else if (isOverdue) {
                    statusBadge = '<span class="badge badge-warning">Overdue</span>';
                } else {
                    statusBadge = '<span class="badge badge-warning">Pending</span>';
                }

                return `
                    <div class="card cursor-pointer hover:opacity-90" onclick="viewAssignment('${a.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${a.title}</h3>
                                <p class="text-sm text-gray-600 mt-1">Course: ${a.course_title}</p>
                                ${dueDate ? `<p class="text-sm text-gray-600">Due: ${dueDate.toLocaleString()}</p>` : ''}
                            </div>
                            <div>
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        });

        document.getElementById('enrollForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const courseCode = document.getElementById('enrollCode').value;
            
            try {
                const result = await apiCall('/api/student/enroll', {
                    method: 'POST',
                    body: JSON.stringify({ course_code: courseCode })
                });
                
                tg.showAlert('Successfully enrolled in course!');
                hideEnrollForm();
                
                // Refresh courses and assignments
                await loadCourses();
                await loadAssignments();
                updateProgress();
            } catch (error) {
                console.error('Enroll error:', error);
                tg.showAlert('Failed to enroll: ' + error.message);
            }
        });

        document.getElementById('submissionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentAssignment) return;
            
            const text = document.getElementById('submissionText').value;
            const fileInput = document.getElementById('submissionFile');
            const file = fileInput.files.length > 0 ? fileInput.files[0] : null;
            
            try {
                // Create form data for file upload
                const formData = new FormData();
                formData.append('text', text);
                if (file) {
                    formData.append('file', file);
                }
                
                const response = await fetch(`/api/student/assignments/${currentAssignment.id}/submit`, {
                    method: 'POST',
                    headers: {
                        'X-Telegram-Init-Data': tg.initData
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API Error');
                }
                
                tg.showAlert('Assignment submitted successfully!');
                hideAssignmentDetail();
                
                // Refresh assignments and progress
                await loadAssignments();
                updateProgress();
            } catch (error) {
                console.error('Submit assignment error:', error);
                tg.showAlert('Failed to submit: ' + error.message);
            }
        });

        // Start the app
        init();
    </script>
</body>
</html>
